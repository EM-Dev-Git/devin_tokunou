# 内部設計書

## 1. はじめに

### 1.1 目的
本文書は、devin_tokunouプロジェクトの内部設計を定義するものである。内部設計とは、システムの内部構造、モジュール構成、処理フロー、およびデータフローなどを定義するものである。

### 1.2 対象範囲
本文書は、devin_tokunouプロジェクトのモジュール構成、クラス設計、処理フロー、およびデータフローを定義する。

### 1.3 関連文書
- 要件定義書
- 外部設計書
- システム構成図

## 2. システムアーキテクチャ

### 2.1 全体アーキテクチャ
devin_tokunouプロジェクトは、FastAPIフレームワークを使用したRESTful APIアプリケーションである。アプリケーションは以下の主要コンポーネントで構成される：

1. **メインアプリケーション**: FastAPIアプリケーションのエントリーポイント
2. **ルーター**: APIエンドポイントの定義
3. **モジュール**: ビジネスロジックの実装
4. **スキーマ**: データモデルの定義
5. **ユーティリティ**: ロギングなどの共通機能

### 2.2 ディレクトリ構造
```
devin_tokunou/
├── app/
│   ├── __init__.py
│   ├── main.py                # メインアプリケーション
│   ├── modules/               # ビジネスロジック
│   │   ├── __init__.py
│   │   ├── item.py            # アイテム関連のビジネスロジック
│   │   └── openai.py          # OpenAI関連のビジネスロジック
│   ├── routers/               # APIルーター
│   │   ├── __init__.py
│   │   ├── items.py           # アイテム関連のエンドポイント
│   │   └── openai.py          # OpenAI関連のエンドポイント
│   ├── schemas/               # データモデル
│   │   ├── __init__.py
│   │   ├── item.py            # アイテム関連のスキーマ
│   │   └── openai.py          # OpenAI関連のスキーマ
│   └── utils/                 # ユーティリティ
│       ├── __init__.py
│       └── logger.py          # ロギングユーティリティ
├── Docs/                      # ドキュメント
│   ├── system_architecture.md
│   ├── system_architecture_diagram.drawio
│   ├── system_architecture_diagram.png
│   ├── 要件定義書.md
│   ├── 外部設計書.md
│   └── 内部設計書.md
├── README.md                  # プロジェクト概要
└── requirements.txt           # 依存パッケージ
```

## 3. モジュール設計

### 3.1 メインアプリケーション（main.py）

#### 3.1.1 責務
- FastAPIアプリケーションの初期化
- ミドルウェアの設定
- ルーターの登録
- グローバル例外ハンドラーの設定
- ルートエンドポイントとヘルスチェックエンドポイントの実装

#### 3.1.2 主要コンポーネント
- **FastAPIアプリケーション**: `app = FastAPI(...)`
- **CORSミドルウェア**: `app.add_middleware(CORSMiddleware, ...)`
- **リクエストログミドルウェア**: `@app.middleware("http") async def log_requests(...)`
- **グローバル例外ハンドラー**: `@app.exception_handler(Exception) async def global_exception_handler(...)`

#### 3.1.3 処理フロー
1. アプリケーション初期化
2. ミドルウェア設定
3. ルーター登録
4. エンドポイント定義
5. 例外ハンドラー設定

### 3.2 ルーターモジュール（routers/）

#### 3.2.1 アイテムルーター（items.py）

##### 3.2.1.1 責務
- アイテム関連のエンドポイント定義
- リクエスト処理とレスポンス生成
- ビジネスロジックの呼び出し
- ログ記録

##### 3.2.1.2 エンドポイント
- `GET /items`: すべてのアイテムを取得
- `GET /items/{item_id}`: 特定のアイテムを取得
- `POST /items/`: 新しいアイテムを作成

##### 3.2.1.3 処理フロー
1. リクエスト受信
2. リクエストIDを使用してログ記録
3. ビジネスロジック呼び出し
4. レスポンス生成
5. 処理結果をログ記録

#### 3.2.2 OpenAIルーター（openai.py）

##### 3.2.2.1 責務
- OpenAI関連のエンドポイント定義
- リクエスト処理とレスポンス生成
- OpenAIビジネスロジックの呼び出し
- ログ記録

##### 3.2.2.2 エンドポイント
- `POST /openai/chat/completions`: チャット完了リクエスト
- `GET /openai/models`: 利用可能なモデル一覧

##### 3.2.2.3 処理フロー
1. リクエスト受信
2. リクエストIDを使用してログ記録
3. OpenAIビジネスロジック呼び出し
4. レスポンス生成
5. 処理結果をログ記録

### 3.3 モジュール（modules/）

#### 3.3.1 アイテムモジュール（item.py）

##### 3.3.1.1 責務
- アイテム関連のビジネスロジック実装
- データアクセス処理
- エラーハンドリング

##### 3.3.1.2 主要関数
- `get_all_items()`: すべてのアイテムを取得
- `get_item_by_id(item_id)`: 特定のアイテムを取得
- `create_new_item(item_id, name)`: 新しいアイテムを作成

##### 3.3.1.3 データ構造
- `fake_items_db`: インメモリデータベース（辞書）

#### 3.3.2 OpenAIモジュール（openai.py）

##### 3.3.2.1 責務
- OpenAI API連携のビジネスロジック実装
- API認証処理
- エラーハンドリング
- ログ記録

##### 3.3.2.2 主要関数
- `get_request_id(request)`: リクエストIDを取得
- `get_openai_client()`: OpenAIクライアントを初期化
- `create_chat_completion(request, chat_request)`: チャット完了リクエスト処理
- `list_available_models(request)`: 利用可能なモデル一覧取得

##### 3.3.2.3 定数
- `DUMMY_OPENAI_API_KEY`: 開発用ダミーAPIキー

### 3.4 スキーマ（schemas/）

#### 3.4.1 アイテムスキーマ（item.py）

##### 3.4.1.1 責務
- アイテム関連のデータモデル定義
- リクエスト/レスポンスのバリデーション

##### 3.4.1.2 クラス
- `Item`: アイテムの基本モデル
- `ItemResponse`: アイテム作成レスポンスモデル
- `ItemsResponse`: アイテム一覧レスポンスモデル

#### 3.4.2 OpenAIスキーマ（openai.py）

##### 3.4.2.1 責務
- OpenAI関連のデータモデル定義
- リクエスト/レスポンスのバリデーション

##### 3.4.2.2 クラス
- `ChatMessage`: チャットメッセージモデル
- `ChatCompletionRequest`: チャット完了リクエストモデル
- `ChatCompletionResponse`: チャット完了レスポンスモデル

### 3.5 ユーティリティ（utils/）

#### 3.5.1 ロガー（logger.py）

##### 3.5.1.1 責務
- ロギング機能の提供
- ログフォーマットの定義
- ログレベルの設定

##### 3.5.1.2 主要関数
- `setup_logger(name, level)`: ロガーの初期化と設定

##### 3.5.1.3 ロガーインスタンス
- `app_logger`: アプリケーション全体のロガー
- `api_logger`: API関連のロガー
- `db_logger`: データベース関連のロガー

## 4. 処理フロー

### 4.1 リクエスト処理フロー

#### 4.1.1 一般的なリクエスト処理
1. クライアントからリクエスト受信
2. リクエストログミドルウェアがリクエストIDを生成し、開始ログを記録
3. ルーターがリクエストを適切なエンドポイントハンドラーにルーティング
4. エンドポイントハンドラーがビジネスロジックを呼び出し
5. ビジネスロジックが処理を実行
6. エンドポイントハンドラーがレスポンスを生成
7. リクエストログミドルウェアが完了ログを記録
8. クライアントにレスポンス送信

#### 4.1.2 エラー処理フロー
1. 処理中に例外発生
2. エンドポイント固有の例外ハンドラーで処理可能な場合は処理
3. 処理できない場合はグローバル例外ハンドラーが処理
4. エラーログを記録
5. エラーレスポンスを生成
6. クライアントにエラーレスポンス送信

### 4.2 OpenAI API連携フロー

#### 4.2.1 チャット完了リクエスト
1. クライアントから`/openai/chat/completions`へのPOSTリクエスト受信
2. リクエストバリデーション
3. リクエストIDを取得
4. OpenAIクライアント初期化
5. （開発環境）モックレスポンス生成
6. （本番環境）OpenAI APIへリクエスト送信
7. レスポンス処理
8. クライアントにレスポンス送信

#### 4.2.2 モデル一覧取得
1. クライアントから`/openai/models`へのGETリクエスト受信
2. リクエストIDを取得
3. OpenAIクライアント初期化
4. （開発環境）モックレスポンス生成
5. （本番環境）OpenAI APIへリクエスト送信
6. レスポンス処理
7. クライアントにレスポンス送信

## 5. データフロー

### 5.1 アイテム管理データフロー

#### 5.1.1 アイテム一覧取得
1. クライアント → ルーター: GETリクエスト
2. ルーター → モジュール: `get_all_items()`呼び出し
3. モジュール → ルーター: アイテム一覧返却
4. ルーター → クライアント: JSONレスポンス

#### 5.1.2 アイテム個別取得
1. クライアント → ルーター: GETリクエスト（item_id指定）
2. ルーター → モジュール: `get_item_by_id(item_id)`呼び出し
3. モジュール → ルーター: アイテム情報返却（または例外発生）
4. ルーター → クライアント: JSONレスポンス（または404エラー）

#### 5.1.3 アイテム作成
1. クライアント → ルーター: POSTリクエスト（item_id, name指定）
2. ルーター → モジュール: `create_new_item(item_id, name)`呼び出し
3. モジュール → ルーター: 作成されたアイテム情報返却（または例外発生）
4. ルーター → クライアント: JSONレスポンス（または400エラー）

### 5.2 OpenAI連携データフロー

#### 5.2.1 チャット完了リクエスト
1. クライアント → ルーター: POSTリクエスト（ChatCompletionRequest）
2. ルーター → モジュール: `create_chat_completion(request, chat_request)`呼び出し
3. モジュール → （本番環境）OpenAI API: APIリクエスト
4. （本番環境）OpenAI API → モジュール: APIレスポンス
5. モジュール → ルーター: ChatCompletionResponse返却
6. ルーター → クライアント: JSONレスポンス

#### 5.2.2 モデル一覧取得
1. クライアント → ルーター: GETリクエスト
2. ルーター → モジュール: `list_available_models(request)`呼び出し
3. モジュール → （本番環境）OpenAI API: APIリクエスト
4. （本番環境）OpenAI API → モジュール: APIレスポンス
5. モジュール → ルーター: モデル一覧返却
6. ルーター → クライアント: JSONレスポンス

## 6. 例外処理設計

### 6.1 例外クラス
FastAPIの標準例外クラス`HTTPException`を使用

### 6.2 例外処理方法
- ビジネスロジック層で適切な例外を発生させる
- ルーター層で例外をキャッチし、適切なエラーレスポンスを返す
- グローバル例外ハンドラーで未処理の例外をキャッチし、500エラーを返す

### 6.3 ログ記録
- 例外発生時にエラーログを記録
- リクエストIDを含めて関連するログを追跡可能にする

## 7. ログ設計

### 7.1 ロガー構成
- `app_logger`: アプリケーション全体のロガー
- `api_logger`: API関連のロガー
- `db_logger`: データベース関連のロガー

### 7.2 ログレベル
- INFO: 通常の操作情報
- WARNING: 警告情報
- ERROR: エラー情報

### 7.3 ログ出力先
標準出力（stdout）

### 7.4 ログフォーマット
```
YYYY-MM-DD HH:MM:SS - ロガー名 - ログレベル - メッセージ
```

## 8. 依存パッケージ

### 8.1 主要パッケージ
- fastapi==0.115.12: FastAPIフレームワーク
- uvicorn==0.34.2: ASGIサーバー
- starlette==0.46.2: ASGIフレームワーク（FastAPIの依存）
- pydantic==2.11.4: データバリデーション
- openai: OpenAI API クライアント

### 8.2 その他の依存パッケージ
- typing-extensions>=4.8.0
- click>=7.0
- h11>=0.8
- annotated-types>=0.6.0
- pydantic-core==2.33.2
- typing-inspection>=0.4.0
- anyio<5,>=3.6.2
- idna>=2.8
- sniffio>=1.1

## 9. 承認

本内部設計書は、プロジェクト関係者によって確認され、承認されたものである。

- 作成日: 2025年5月19日
- 作成者: Devin AI
- バージョン: 1.0
