# 外部設計書

## 1. はじめに

### 1.1 目的
本文書は、devin_tokunouプロジェクトの外部設計を定義するものである。外部設計とは、システムの外部から見た振る舞いや、ユーザーインターフェース、外部システムとの連携方法などを定義するものである。

### 1.2 対象範囲
本文書は、devin_tokunouプロジェクトのAPI仕様、データモデル、外部システム連携、およびエラーハンドリングを定義する。

### 1.3 関連文書
- 要件定義書
- 内部設計書
- システム構成図

## 2. システム概要

### 2.1 システム構成
システムは以下のコンポーネントで構成される：
- Windows上のWSL（Windows Subsystem for Linux）
- WSL上のUbuntu
- Ubuntu上のFastAPIアプリケーション
- Ubuntu上のデータベース
- 外部サービスとしてのOpenAI API

### 2.2 システム構成図
システム構成図は`Docs/system_architecture_diagram.png`および`Docs/system_architecture.md`に記載されている。

## 3. API仕様

### 3.1 共通仕様

#### 3.1.1 ベースURL
```
http://localhost:8000
```

#### 3.1.2 リクエスト形式
- Content-Type: application/json
- 文字コード: UTF-8

#### 3.1.3 レスポンス形式
- Content-Type: application/json
- 文字コード: UTF-8

#### 3.1.4 共通ヘッダー
特に指定なし

#### 3.1.5 エラーレスポンス
```json
{
  "detail": "エラーメッセージ"
}
```

#### 3.1.6 ステータスコード
- 200: 成功
- 400: リクエストエラー
- 404: リソースが見つからない
- 500: サーバーエラー

### 3.2 エンドポイント一覧

#### 3.2.1 ルートエンドポイント
- **URL**: `/`
- **メソッド**: GET
- **説明**: ウェルカムメッセージを返す
- **レスポンス**:
  ```json
  {
    "message": "Welcome to devin_tokunou API"
  }
  ```

#### 3.2.2 ヘルスチェックエンドポイント
- **URL**: `/health`
- **メソッド**: GET
- **説明**: システムの稼働状態を確認する
- **レスポンス**:
  ```json
  {
    "status": "healthy"
  }
  ```

#### 3.2.3 アイテム一覧取得
- **URL**: `/items`
- **メソッド**: GET
- **説明**: すべてのアイテムを取得する
- **レスポンス**:
  ```json
  {
    "plumbus": {
      "name": "Plumbus"
    },
    "gun": {
      "name": "Portal Gun"
    }
  }
  ```

#### 3.2.4 アイテム個別取得
- **URL**: `/items/{item_id}`
- **メソッド**: GET
- **説明**: 特定のアイテムを取得する
- **パスパラメータ**:
  - `item_id`: アイテムID（文字列）
- **レスポンス**:
  ```json
  {
    "name": "Plumbus"
  }
  ```
- **エラーレスポンス**:
  - 404: アイテムが見つからない場合
    ```json
    {
      "detail": "Item {item_id} not found"
    }
    ```

#### 3.2.5 アイテム作成
- **URL**: `/items/`
- **メソッド**: POST
- **説明**: 新しいアイテムを作成する
- **クエリパラメータ**:
  - `item_id`: アイテムID（文字列）
  - `name`: アイテム名（文字列）
- **レスポンス**:
  ```json
  {
    "item_id": "new_item",
    "name": "New Item"
  }
  ```
- **エラーレスポンス**:
  - 400: アイテムが既に存在する場合
    ```json
    {
      "detail": "Item {item_id} already exists"
    }
    ```

#### 3.2.6 OpenAIチャット完了
- **URL**: `/openai/chat/completions`
- **メソッド**: POST
- **説明**: OpenAI APIを使用してチャット完了を生成する
- **リクエスト**:
  ```json
  {
    "model": "gpt-3.5-turbo",
    "messages": [
      {
        "role": "user",
        "content": "Hello, how are you?"
      }
    ],
    "temperature": 0.7,
    "max_tokens": 150
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": "chatcmpl-dummy-id",
    "object": "chat.completion",
    "created": 1683123456,
    "model": "gpt-3.5-turbo",
    "choices": [
      {
        "index": 0,
        "message": {
          "role": "assistant",
          "content": "This is a dummy response from the OpenAI API. In a real implementation, this would be the actual response from the OpenAI API."
        },
        "finish_reason": "stop"
      }
    ],
    "usage": {
      "prompt_tokens": 10,
      "completion_tokens": 20,
      "total_tokens": 30
    }
  }
  ```
- **エラーレスポンス**:
  - 500: OpenAI APIエラーの場合
    ```json
    {
      "detail": "OpenAI API error: {error_message}"
    }
    ```

#### 3.2.7 OpenAIモデル一覧
- **URL**: `/openai/models`
- **メソッド**: GET
- **説明**: 利用可能なOpenAIモデルの一覧を取得する
- **レスポンス**:
  ```json
  {
    "data": [
      {
        "id": "gpt-3.5-turbo",
        "object": "model",
        "created": 1677610602
      },
      {
        "id": "gpt-4",
        "object": "model",
        "created": 1677649963
      },
      {
        "id": "text-embedding-ada-002",
        "object": "model",
        "created": 1671217299
      }
    ]
  }
  ```
- **エラーレスポンス**:
  - 500: OpenAI APIエラーの場合
    ```json
    {
      "detail": "OpenAI API error: {error_message}"
    }
    ```

### 3.3 API ドキュメント
FastAPIは自動的に以下のAPIドキュメントを生成する：
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## 4. データモデル

### 4.1 アイテムモデル

#### 4.1.1 Item
```json
{
  "name": "文字列"
}
```

#### 4.1.2 ItemResponse
```json
{
  "item_id": "文字列",
  "name": "文字列"
}
```

#### 4.1.3 ItemsResponse
```json
{
  "items": {
    "アイテムID": {
      "name": "文字列"
    },
    ...
  }
}
```

### 4.2 OpenAIモデル

#### 4.2.1 ChatMessage
```json
{
  "role": "文字列（user, assistant, system）",
  "content": "文字列"
}
```

#### 4.2.2 ChatCompletionRequest
```json
{
  "model": "文字列（デフォルト: gpt-3.5-turbo）",
  "messages": [ChatMessage, ...],
  "temperature": "数値（デフォルト: 0.7）",
  "max_tokens": "整数（デフォルト: 150）"
}
```

#### 4.2.3 ChatCompletionResponse
```json
{
  "id": "文字列",
  "object": "文字列",
  "created": "整数（タイムスタンプ）",
  "model": "文字列",
  "choices": [
    {
      "index": "整数",
      "message": {
        "role": "文字列",
        "content": "文字列"
      },
      "finish_reason": "文字列"
    },
    ...
  ],
  "usage": {
    "prompt_tokens": "整数",
    "completion_tokens": "整数",
    "total_tokens": "整数"
  }
}
```

## 5. 外部システム連携

### 5.1 OpenAI API連携

#### 5.1.1 認証方法
- 環境変数`OPENAI_API_KEY`にAPIキーを設定
- 開発環境ではダミーのAPIキーを使用

#### 5.1.2 エンドポイント
- チャット完了: `https://api.openai.com/v1/chat/completions`
- モデル一覧: `https://api.openai.com/v1/models`

#### 5.1.3 エラーハンドリング
- OpenAI APIからのエラーレスポンスをキャッチし、適切なエラーメッセージを返す
- ログにエラー詳細を記録

## 6. エラーハンドリング

### 6.1 エラーコード一覧
- 400: Bad Request - リクエストパラメータが不正
- 404: Not Found - リソースが見つからない
- 500: Internal Server Error - サーバー内部エラー

### 6.2 グローバル例外ハンドラー
すべての未処理例外をキャッチし、適切なエラーレスポンスを返す。また、例外の詳細をログに記録する。

## 7. ログ仕様

### 7.1 ログフォーマット
```
YYYY-MM-DD HH:MM:SS - ロガー名 - ログレベル - メッセージ
```

### 7.2 ログレベル
- INFO: 通常の操作情報
- WARNING: 警告情報
- ERROR: エラー情報

### 7.3 ログ出力先
標準出力（stdout）

## 8. 承認

本外部設計書は、プロジェクト関係者によって確認され、承認されたものである。

- 作成日: 2025年5月19日
- 作成者: Devin AI
- バージョン: 1.0
